@model IEnumerable<CrossConvo.Models.Utilisateur>
@using Microsoft.AspNetCore.Identity

@inject SignInManager<Utilisateur> SignInManager
@inject UserManager<Utilisateur> UserManager
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="~/css/PageExplorer.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />
    <script src="~/js/switch_theme.js"></script>
    <title>Explorer Page</title>
</head>
<body>

    <form asp-controller="Utilisateurs" asp-action="Search" method="POST">
        <input type="text" name="searchName" id="searchName" placeholder="Rechercher..." />
        <input type="submit" value="Rechercher" />
    </form>

    <div class="entity-container">
        @foreach (var user in Model)
        {
            <div class="entity-card">
                <strong>@Html.DisplayFor(modelItem => user.Nom) @Html.DisplayFor(modelItem => user.Prenom)</strong><br />
                <strong>@Html.DisplayFor(modelItem => user.Email)</strong>
                <form id="addFriendForm" method="post" action="/Home/AddFriend">
                    @Html.AntiForgeryToken() 
                    <input type="hidden" name="userId" id="friendUserId" value="@user.Id" />  
                    <div>
                        <button type="submit" class="fas fa-plus icon_ajout add-friend"></button>
                    </div>
                </form>

                @if (user.Posts != null && user.Posts.Any())
                {
                    <div class="post-container">
                        @foreach (var post in user.Posts)
                        {
                            <div class="post">
                                <strong>@Html.DisplayFor(modelItem => post.Title)</strong><br />
                                <strong>@Html.DisplayFor(modelItem => post.Contenu)</strong><br />
                                <strong>@Html.DisplayFor(modelItem => post.Utilisateur.Nom)</strong><br />
                                <strong>@Html.DisplayFor(modelItem => post.Utilisateur.Email)</strong><br />
                                <strong>Likes: @Html.DisplayFor(modelItem => post.Likes)</strong><br />

                                @if (SignInManager.IsSignedIn(User))
                                {
                                    if (post.LikedUserIds.Contains(user.Id))
                                    {
                                        <i class="far fa-heart icon11"></i>
                                    }
                                    else
                                    {
                                        <i class="far fa-heart icon111"></i>
                                    }
                                }

                                @if (post.File != null && post.File.Length > 0)
                                {
                                    <p>
                                        <img src="data:image/jpeg;base64,@Convert.ToBase64String(post.File)" alt="Post Image" class="img-thumbnail" />
                                    </p>
                                }

                                @if (post.Commentaires != null && post.Commentaires.Any())
                                {
                                    <div class="comment-container">
                                        @foreach (var comment in post.Commentaires)
                                        {
                                            <div class="comment">
                                                <strong>@Html.DisplayFor(modelItem => comment.Utilisateur.Email)</strong><br />
                                                <strong>@Html.DisplayFor(modelItem => comment.Utilisateur.Nom)</strong><br />
                                                <strong>@Html.DisplayFor(modelItem => comment.PublicationDate)</strong><br />
                                                <strong>@Html.DisplayFor(modelItem => comment.Contenu)</strong><br />
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p>Cette utilisateur a 0 post.</p>
                }
            </div>
        }
    </div>

    <script src="~/js/lightbox-plus-jquery.js"></script>
    <script>
        $(".add-friend").click(function () {
            var userId = $(this).data("user-id");

            $.ajax({
                url: "/Home/AddFriend",
                type: "POST",
                data: { userId: userId },
                success: function (result) {
                    if (result.success) {
                        // Handle success, e.g., update UI
                        console.log("Friend added successfully");
                    } else {
                        // Handle failure, e.g., display error message
                        console.error("Failed to add friend: " + result.error);
                    }
                },
                error: function () {
                    console.error("An error occurred during the AJAX request");
                }
            });
        });
    </script>
</body>
</html>